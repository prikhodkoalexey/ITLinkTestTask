# Архитектура ITLinkTestTask

## Слои приложения

- **Networking.** [`DefaultHTTPClient`](../ITLinkTestTask/NetworkingLayer/HTTP/HTTPClient.swift) выполняет HTTP‑запросы. [`DefaultLinksFileRemoteDataSource.fetchLinks()`](../ITLinkTestTask/NetworkingLayer/Services/LinksFileRemoteDataSource.swift) скачивает [`images.txt`](https://it-link.ru/test/images.txt) и превращает каждую строку в [`ImageLinkRecord`](../ITLinkTestTask/NetworkingLayer/Models/ImageLinkRecord.swift). [`DefaultImageMetadataProbe.metadata(for:)`](../ITLinkTestTask/NetworkingLayer/Services/ImageMetadataProbe.swift) при необходимости считывает MIME и подписи файлов. [`DefaultRemoteGalleryService`](../ITLinkTestTask/DomainLayer/UseCases/RemoteGalleryService.swift) управляет этими компонентами, повторяет неудачные попытки и слушает [`DefaultReachabilityService`](../ITLinkTestTask/NetworkingLayer/Services/NetworkReachabilityService.swift). На выходе слой отдаёт [`LinksFileSnapshot`](../ITLinkTestTask/NetworkingLayer/Models/ImageLinkRecord.swift) и метаданные изображений.
- **Storage.** [`DefaultDiskStore`](../ITLinkTestTask/StorageLayer/DefaultDiskStore.swift) создаёт каталоги `Storage/links`, `Storage/thumbnails`, `Storage/originals`. [`DefaultLinksFileCache`](../ITLinkTestTask/StorageLayer/LinksFileCache.swift) сериализует `LinksFileSnapshot` в `links.json`. [`DefaultImageDataCache`](../ITLinkTestTask/StorageLayer/ImageDataCache.swift) сохраняет превью (PNG) и оригиналы на диск, [`DefaultMemoryImageCache`](../ITLinkTestTask/StorageLayer/MemoryImageCache.swift) держит те же данные в оперативной памяти. Слоям выше возвращаются `Data`, даже если сети нет.
- **Domain.** [`DefaultGalleryRepository`](../ITLinkTestTask/DomainLayer/Repositories/DefaultGalleryRepository.swift) принимает `LinksFileSnapshot`, формирует [`GallerySnapshot`](../ITLinkTestTask/DomainLayer/Repositories/GalleryRepository.swift) с [`GalleryItem.image`](../ITLinkTestTask/DomainLayer/Repositories/GalleryRepository.swift) и `GalleryItem.placeholder`, управляет цепочкой «оперативный кэш → диск → сеть» и предоставляет юзкейсы ([`LoadGallerySnapshotUseCase`](../ITLinkTestTask/DomainLayer/UseCases/GalleryUseCases.swift), [`RefreshGallerySnapshotUseCase`](../ITLinkTestTask/DomainLayer/UseCases/GalleryUseCases.swift), [`FetchGalleryImageDataUseCase`](../ITLinkTestTask/DomainLayer/UseCases/GalleryUseCases.swift), [`FetchGalleryMetadataUseCase`](../ITLinkTestTask/DomainLayer/UseCases/GalleryUseCases.swift)).
- **Presentation.** [`GalleryViewModel`](../ITLinkTestTask/Presentation/Gallery/GalleryViewModel.swift) хранит [`GalleryViewState`](../ITLinkTestTask/Presentation/Gallery/GalleryViewState.swift) — модель экрана. [`GalleryViewController`](../ITLinkTestTask/Presentation/Gallery/GalleryViewController.swift) вместе с [`GalleryImageLoader`](../ITLinkTestTask/Presentation/Gallery/GalleryImageLoader.swift) отображают грид и подгружают превью. [`ImageViewerViewModel`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerViewModel.swift) и [`ImageViewerViewController`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerViewController.swift) отвечают за полноразмерный просмотр, жесты, перелистывание и шаринг.

---

## Как приложение загружает `images.txt` и формирует модель для грида

Задача: получить текстовый файл, собрать из него `GallerySnapshot` (список `GalleryItem`) и обновить `GalleryViewModel`.

1. [`SceneDelegate.scene(_:willConnectTo:options:)`](../ITLinkTestTask/Application/SceneDelegate.swift) создаёт окно. [`AppEnvironment.makeDefault()`](../ITLinkTestTask/Application/AppEnvironment.swift) настраивает все слои и через [`GalleryPresentationAssembly.makeRootViewController()`](../ITLinkTestTask/Presentation/Gallery/GalleryPresentationAssembly.swift) возвращает `UINavigationController` с `GalleryViewController`.
2. [`GalleryViewController.bindViewModel()`](../ITLinkTestTask/Presentation/Gallery/GalleryViewController+State.swift) подписывается на состояние и запускает [`GalleryViewModel.loadInitialSnapshot()`](../ITLinkTestTask/Presentation/Gallery/GalleryViewModel.swift).
3. `GalleryViewModel` вызывает [`LoadGallerySnapshotUseCase`](../ITLinkTestTask/DomainLayer/UseCases/GalleryUseCases.swift), который делегирует работу [`DefaultGalleryRepository.loadInitialSnapshot()`](../ITLinkTestTask/DomainLayer/Repositories/DefaultGalleryRepository.swift).
4. Репозиторий сначала обращается к [`DefaultLinksFileCache.loadSnapshot()`](../ITLinkTestTask/StorageLayer/LinksFileCache.swift). Если `links.json` существует, `GallerySnapshot` собирается локально.
5. При отсутствии кэша [`DefaultRemoteGalleryService.refreshLinks()`](../ITLinkTestTask/DomainLayer/UseCases/RemoteGalleryService.swift) использует [`DefaultLinksFileRemoteDataSource.fetchLinks()`](../ITLinkTestTask/NetworkingLayer/Services/LinksFileRemoteDataSource.swift): текст скачивается, проверяется `Content-Type`, каждая строка превращается в `ImageLinkRecord` (картинка, ссылка не на картинку, либо посторонний текст).
6. Свежий `LinksFileSnapshot` сохраняется [`DefaultLinksFileCache.saveSnapshot()`](../ITLinkTestTask/StorageLayer/LinksFileCache.swift) и передаётся в [`DefaultGalleryRepository.makeSnapshot(from:)`](../ITLinkTestTask/DomainLayer/Repositories/DefaultGalleryRepository.swift), который формирует `GalleryItem.image` и `GalleryItem.placeholder`.
7. `GalleryViewModel` обновляет [`GalleryViewState`](../ITLinkTestTask/Presentation/Gallery/GalleryViewState.swift), а [`GalleryViewController.apply(state:)`](../ITLinkTestTask/Presentation/Gallery/GalleryViewController+State.swift) применяет diffable snapshot — коллекция получает готовую модель.

---

## Как заполняется ячейка превью

1. После применения снапшота `UICollectionView` создаёт [`GalleryImageCell`](../ITLinkTestTask/Presentation/Gallery/GalleryCollectionViewCells.swift) для элементов с картинками и [`GalleryPlaceholderCell`](../ITLinkTestTask/Presentation/Gallery/GalleryCollectionViewCells.swift) для остальных. В методе [`GalleryPlaceholderCell.configure`](../ITLinkTestTask/Presentation/Gallery/GalleryCollectionViewCells.swift) задаётся конкретная подпись («Ссылка не на изображение» или «Некорректная запись»), чтобы объяснить отсутствие превью.
2. Для `GalleryImageCell` метод [`GalleryViewController.loadImage(for:at:cell:)`](../ITLinkTestTask/Presentation/Gallery/GalleryViewController+DataSource.swift) вызывает [`GalleryImageLoader.image(for:variant:)`](../ITLinkTestTask/Presentation/Gallery/GalleryImageLoader.swift).
3. `GalleryImageLoader` строит ключ и смотрит в собственный `NSCache`. Если записи нет — обращается к [`DefaultMemoryImageCache.data(for:variant:)`](../ITLinkTestTask/StorageLayer/MemoryImageCache.swift).
4. При промахе проверяется [`DefaultImageDataCache.data(for:variant:)`](../ITLinkTestTask/StorageLayer/ImageDataCache.swift), который ищет PNG‑превью на диске (`Storage/thumbnails`) и обновляет дату доступа для LRU.
5. Если данных нет и там, [`DefaultGalleryRepository.imageData(for:variant:)`](../ITLinkTestTask/DomainLayer/Repositories/DefaultGalleryRepository.swift) действует по цепочке:
   - рекурсивно запрашивает оригинал (`imageData(for: .original)`), который поочерёдно ищет данные в оперативном кэше, на диске (`Storage/originals`) и, при необходимости, скачивает их через `downloadImage`;
   - сохраняет оригинал в оба кэша;
   - [`makeThumbnailData`](../ITLinkTestTask/DomainLayer/Repositories/DefaultGalleryRepository.swift) генерирует PNG‑превью, также записывает его на диск и в память.
6. [`GalleryImageLoader.decodeImage`](../ITLinkTestTask/Presentation/Gallery/GalleryImageLoader.swift) на фоновой очереди превращает `Data` в `UIImage`, размещает его в `NSCache` и передаёт в [`GalleryImageCell.configure`](../ITLinkTestTask/Presentation/Gallery/GalleryCollectionViewCells.swift).
7. Если ни один уровень не вернул данные (изображение ещё не качали, а сети нет), ячейка остаётся с фоновой заглушкой и отображаемой подписью плейсхолдера.

---

## Как устроен экран просмотра оригиналов

1. [`collectionView(_:didSelectItemAt:)`](../ITLinkTestTask/Presentation/Gallery/GalleryViewController+DataSource.swift) извлекает все `GalleryImage.url`, находит индекс выбранного элемента и через [`ImageViewerAssembly`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerAssembly.swift) создаёт [`ImageViewerViewController`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerViewController.swift).
2. В `viewDidLoad` контроллер настраивает горизонтальную пагинацию, регистрирует [`ImageViewerPageCell`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerPageCell.swift), привязывает обратные вызовы и вызывает [`ImageViewerViewModel.start()`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerViewModel.swift).
3. [`ImageViewerViewModel.loadItem(at:)`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerViewModel.swift) проверяет текущее состояние страницы, запоминает предыдущий `UIImage`, запускает `Task` и обращается к [`GalleryImageLoader.image(for: .original)`](../ITLinkTestTask/Presentation/Gallery/GalleryImageLoader.swift). Благодаря общей инфраструктуре используются те же кэши.
4. После завершения загрузки статус страницы обновляется: `.loaded(image)` или `.failed(previousImage)`. [`ImageViewerPageCell.configure(with:)`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerPageCell.swift) показывает индикатор, изображение или кнопку «Повторить», а `adjustImageLayout()` подгоняет `UIScrollView` под текущий снимок. Жесты двойного касания и pinch настроены при создании ячейки.
5. `ImageViewerViewController` управляет `UIPageControl`, скрывает и показывает элементы интерфейса (`toggleChrome`, затрагивая статус‑бар), обрабатывает `handleBack()` и `handleShare()` (создаёт `UIActivityViewController`). [`ImageViewerViewModel.loadSurroundings()`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerViewModel.swift) заранее подкачивает соседние изображения для плавного листания.

---

## Как всё ведёт себя без интернета

1. [`DefaultGalleryRepository.loadInitialSnapshot()`](../ITLinkTestTask/DomainLayer/Repositories/DefaultGalleryRepository.swift) всегда сначала обращается к [`DefaultLinksFileCache`](../ITLinkTestTask/StorageLayer/LinksFileCache.swift). Если `links.json` лежит на диске, список картинок появляется без сети.
2. При [`GalleryViewModel.refreshSnapshot()`](../ITLinkTestTask/Presentation/Gallery/GalleryViewModel.swift) репозиторий вызывает [`DefaultRemoteGalleryService.performWithRetry`](../ITLinkTestTask/DomainLayer/UseCases/RemoteGalleryService.swift). В случае ошибки сервис проверяет `reachability.currentStatus`, и если связи нет, `waitForRetry` включает [`DefaultReachabilityService.startMonitoring()`](../ITLinkTestTask/NetworkingLayer/Services/NetworkReachabilityService.swift). Как только `NWPath` переходит в `.satisfied` или `.constrained`, монитор отключается, и попытка повторяется автоматически.
3. [`GalleryViewController.apply(state:)`](../ITLinkTestTask/Presentation/Gallery/GalleryViewController+State.swift) при состоянии «пусто + ошибка» запускает [`startReachabilityMonitoring()`](../ITLinkTestTask/Presentation/Gallery/GalleryViewController+State.swift) и [`viewModel.retry()`](../ITLinkTestTask/Presentation/Gallery/GalleryViewModel.swift) — после восстановления сети загрузка инициируется без участия пользователя.
4. Превью и оригиналы, которые уже лежат в [`DefaultImageDataCache`](../ITLinkTestTask/StorageLayer/ImageDataCache.swift) и [`DefaultMemoryImageCache`](../ITLinkTestTask/StorageLayer/MemoryImageCache.swift), выдаются сразу. Если конкретное изображение ещё ни разу не загружалось, `DefaultGalleryRepository.imageData` выбрасывает [`GalleryRepositoryError.imageDataUnavailable`](../ITLinkTestTask/DomainLayer/Repositories/GalleryRepository.swift): в гриде остаётся фон, а [`ImageViewerPageCell`](../ITLinkTestTask/Presentation/ImageViewer/ImageViewerPageCell.swift) показывает кнопку «Повторить».
