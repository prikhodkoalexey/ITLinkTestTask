name: CI

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: macos-26
    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.0.1
        run: sudo xcode-select -switch /Applications/Xcode_26.0.1.app

      - name: Build project
        run: |
          set -eo pipefail
          xcodebuild build \
            -project ITLinkTestTask.xcodeproj \
            -scheme ITLinkTestTask \
            -sdk iphonesimulator \
            -quiet \
            CODE_SIGNING_ALLOWED=NO

  unit-tests:
    name: Unit Tests
    runs-on: macos-26
    needs: build
    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "iPhone 17 iOS 26.0"
            destination: "platform=iOS Simulator,name=iPhone 17,OS=26.0"
            cache-key: iph17-os260
          - name: "iPhone 16 Pro iOS 18.6"
            destination: "platform=iOS Simulator,name=iPhone 16 Pro,OS=18.6"
            cache-key: iph16pro-os186

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.0.1
        run: sudo xcode-select -switch /Applications/Xcode_26.0.1.app

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData/${{ matrix.cache-key }}
          key: derived-${{ runner.os }}-${{ matrix.cache-key }}-${{ hashFiles('ITLinkTestTask.xcodeproj/project.pbxproj') }}
          restore-keys: |
            derived-${{ runner.os }}-
            derived-

      - name: Cache SwiftPM artifacts
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved', '**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run unit tests
        id: run-unit-tests
        env:
          DESTINATION: ${{ matrix.destination }}
          DERIVED_PATH: DerivedData/${{ matrix.cache-key }}
          XCRESULT_PATH: TestResults/${{ matrix.cache-key }}.xcresult
        run: |
          set -eo pipefail
          mkdir -p "$(dirname "$XCRESULT_PATH")"
          xcodebuild test \
            -project ITLinkTestTask.xcodeproj \
            -scheme ITLinkTestTask \
            -destination "$DESTINATION" \
            -derivedDataPath "$DERIVED_PATH" \
            -resultBundlePath "$XCRESULT_PATH" \
            -only-testing:ITLinkTestTaskTests \
            -quiet \
            CODE_SIGNING_ALLOWED=NO
          echo "xcresult_path=$XCRESULT_PATH" >> "$GITHUB_OUTPUT"

      - name: Publish results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: UnitTests-${{ matrix.cache-key }}
          path: ${{ steps.run-unit-tests.outputs.xcresult_path }}

  ui-tests:
    name: UI Tests
    runs-on: macos-26
    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
    needs: unit-tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "iPhone 16 Pro iOS 18.6"
            destination: "platform=iOS Simulator,name=iPhone 16 Pro,OS=18.6"
            cache-key: ui-iph16pro-os186
    timeout-minutes: 40

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.0.1
        run: sudo xcode-select -switch /Applications/Xcode_26.0.1.app

      - name: Reset simulators
        run: |
          set -eo pipefail
          xcrun simctl shutdown all || true
          xcrun simctl erase all || true
          sudo pkill -9 -f CoreSimulator || true

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData/${{ matrix.cache-key }}
          key: derived-ui-${{ runner.os }}-${{ matrix.cache-key }}-${{ hashFiles('ITLinkTestTask.xcodeproj/project.pbxproj') }}
          restore-keys: |
            derived-ui-${{ runner.os }}-
            derived-ui-

      - name: Cache SwiftPM artifacts
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved', '**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run UI tests
        id: run-ui-tests
        env:
          DESTINATION: ${{ matrix.destination }}
          DERIVED_PATH: DerivedData/${{ matrix.cache-key }}
          XCRESULT_PATH: TestResults/${{ matrix.cache-key }}.xcresult
        run: |
          set -eo pipefail
          mkdir -p "$(dirname "$XCRESULT_PATH")"
          xcodebuild test \
            -project ITLinkTestTask.xcodeproj \
            -scheme ITLinkTestTask \
            -destination "$DESTINATION" \
            -derivedDataPath "$DERIVED_PATH" \
            -resultBundlePath "$XCRESULT_PATH" \
            -only-testing:ITLinkTestTaskUITests \
            -quiet \
            CODE_SIGNING_ALLOWED=NO
          echo "xcresult_path=$XCRESULT_PATH" >> "$GITHUB_OUTPUT"

      - name: Publish UI test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: UITests-${{ matrix.cache-key }}
          path: ${{ steps.run-ui-tests.outputs.xcresult_path }}
